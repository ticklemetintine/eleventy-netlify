// Copyright (c) 2013 The Chromium Authors. All rights reserved.
// https://github.com/GoogleChrome/dialog-polyfill/blob/v0.5.0/LICENSE
(function(l,e){"object"===typeof exports&&"undefined"!==typeof module?module.exports=e():"function"===typeof define&&define.amd?define(e):(l=l||self,l.dialogPolyfill=e())})(this,function(){function l(a){for(;a&&a!==document.body;){var b=window.getComputedStyle(a),d=function(a,d){return!(void 0===b[a]||b[a]===d)};if(1>b.opacity||d("zIndex","auto")||d("transform","none")||d("mixBlendMode","normal")||d("filter","none")||d("perspective","none")||"isolate"===b.isolation||"fixed"===b.position||"touch"===
b.webkitOverflowScrolling)return!0;a=a.parentElement}return!1}function e(a){for(;a;){if("dialog"===a.localName)return a;a=a.parentElement}return null}function n(a){a&&a.blur&&a!==document.body&&a.blur()}function m(a){return a&&a.hasAttribute("method")?"dialog"===a.getAttribute("method").toLowerCase():!1}function p(a){this.dialog_=a;this.openAsModal_=this.replacedStyleTop_=!1;a.hasAttribute("role")||a.setAttribute("role","dialog");a.show=this.show.bind(this);a.showModal=this.showModal.bind(this);a.close=
this.close.bind(this);"returnValue"in a||(a.returnValue="");if("MutationObserver"in window)(new MutationObserver(this.maybeHideModal.bind(this))).observe(a,{attributes:!0,attributeFilter:["open"]});else{var b=!1,d=function(){b?this.downgradeModal():this.maybeHideModal();b=!1}.bind(this),c,g=function(f){f.target===a&&(b|="DOMNodeRemoved"===f.type.substr(0,14),window.clearTimeout(c),c=window.setTimeout(d,0))};["DOMAttrModified","DOMNodeRemoved","DOMNodeRemovedFromDocument"].forEach(function(b){a.addEventListener(b,
g)})}Object.defineProperty(a,"open",{set:this.setOpen.bind(this),get:a.hasAttribute.bind(a,"open")});this.backdrop_=document.createElement("div");this.backdrop_.className="backdrop";this.backdrop_.addEventListener("click",this.backdropClick_.bind(this))}var k=window.CustomEvent;k&&"object"!==typeof k||(k=function(a,b){b=b||{};var d=document.createEvent("CustomEvent");d.initCustomEvent(a,!!b.bubbles,!!b.cancelable,b.detail||null);return d},k.prototype=window.Event.prototype);p.prototype={get dialog(){return this.dialog_},
maybeHideModal:function(){this.dialog_.hasAttribute("open")&&document.body.contains(this.dialog_)||this.downgradeModal()},downgradeModal:function(){this.openAsModal_&&(this.openAsModal_=!1,this.dialog_.style.zIndex="",this.replacedStyleTop_&&(this.dialog_.style.top="",this.replacedStyleTop_=!1),this.backdrop_.parentNode&&this.backdrop_.parentNode.removeChild(this.backdrop_),c.dm.removeDialog(this))},setOpen:function(a){a?this.dialog_.hasAttribute("open")||this.dialog_.setAttribute("open",""):(this.dialog_.removeAttribute("open"),
this.maybeHideModal())},backdropClick_:function(a){if(this.dialog_.hasAttribute("tabindex"))this.dialog_.focus();else{var b=document.createElement("div");this.dialog_.insertBefore(b,this.dialog_.firstChild);b.tabIndex=-1;b.focus();this.dialog_.removeChild(b)}b=document.createEvent("MouseEvents");b.initMouseEvent(a.type,a.bubbles,a.cancelable,window,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,a.relatedTarget);this.dialog_.dispatchEvent(b);a.stopPropagation()},
focus_:function(){var a=this.dialog_.querySelector("[autofocus]:not([disabled])");!a&&0<=this.dialog_.tabIndex&&(a=this.dialog_);a||(a=["button","input","keygen","select","textarea"].map(function(a){return a+":not([disabled])"}),a.push('[tabindex]:not([disabled]):not([tabindex=""])'),a=this.dialog_.querySelector(a.join(", ")));n(document.activeElement);a&&a.focus()},updateZIndex:function(a,b){if(a<b)throw Error("dialogZ should never be < backdropZ");this.dialog_.style.zIndex=a;this.backdrop_.style.zIndex=
b},show:function(){this.dialog_.open||(this.setOpen(!0),this.focus_())},showModal:function(){if(this.dialog_.hasAttribute("open"))throw Error("Failed to execute 'showModal' on dialog: The element is already open, and therefore cannot be opened modally.");if(!document.body.contains(this.dialog_))throw Error("Failed to execute 'showModal' on dialog: The element is not in a Document.");if(!c.dm.pushDialog(this))throw Error("Failed to execute 'showModal' on dialog: There are too many open modal dialogs.");
l(this.dialog_.parentElement)&&console.warn("A dialog is being shown inside a stacking context. This may cause it to be unusable. For more information, see this link: https://github.com/GoogleChrome/dialog-polyfill/#stacking-context");this.setOpen(!0);this.openAsModal_=!0;c.needsCentering(this.dialog_)?(c.reposition(this.dialog_),this.replacedStyleTop_=!0):this.replacedStyleTop_=!1;this.dialog_.parentNode.insertBefore(this.backdrop_,this.dialog_.nextSibling);this.focus_()},close:function(a){if(!this.dialog_.hasAttribute("open"))throw Error("Failed to execute 'close' on dialog: The element does not have an 'open' attribute, and therefore cannot be closed.");
this.setOpen(!1);void 0!==a&&(this.dialog_.returnValue=a);a=new k("close",{bubbles:!1,cancelable:!1});this.dialog_.dispatchEvent(a)}};var c={reposition:function(a){var b=document.body.scrollTop||document.documentElement.scrollTop;a.style.top=Math.max(b,b+(window.innerHeight-a.offsetHeight)/2)+"px"},isInlinePositionSetByStylesheet:function(a){for(var b=0;b<document.styleSheets.length;++b){var d=document.styleSheets[b],c=null;try{c=d.cssRules}catch(q){}if(c)for(d=0;d<c.length;++d){var g=c[d],f=null;
try{f=document.querySelectorAll(g.selectorText)}catch(q){}var e;if(!(e=!f)){a:{for(e=0;e<f.length;++e)if(f[e]===a){f=!0;break a}f=!1}e=!f}if(!e&&(f=g.style.getPropertyValue("top"),g=g.style.getPropertyValue("bottom"),f&&"auto"!==f||g&&"auto"!==g))return!0}}return!1},needsCentering:function(a){return"absolute"!==window.getComputedStyle(a).position||"auto"!==a.style.top&&""!==a.style.top||"auto"!==a.style.bottom&&""!==a.style.bottom?!1:!c.isInlinePositionSetByStylesheet(a)},forceRegisterDialog:function(a){(window.HTMLDialogElement||
a.showModal)&&console.warn("This browser already supports <dialog>, the polyfill may not work correctly",a);if("dialog"!==a.localName)throw Error("Failed to register dialog: The element is not a dialog.");new p(a)},registerDialog:function(a){a.showModal||c.forceRegisterDialog(a)},DialogManager:function(){this.pendingDialogStack=[];var a=this.checkDOM_.bind(this);this.overlay=document.createElement("div");this.overlay.className="_dialog_overlay";this.overlay.addEventListener("click",function(b){this.forwardTab_=
void 0;b.stopPropagation();a([])}.bind(this));this.handleKey_=this.handleKey_.bind(this);this.handleFocus_=this.handleFocus_.bind(this);this.zIndexLow_=1E5;this.zIndexHigh_=100150;this.forwardTab_=void 0;"MutationObserver"in window&&(this.mo_=new MutationObserver(function(b){var c=[];b.forEach(function(a){for(var b=0,d;d=a.removedNodes[b];++b)d instanceof Element&&("dialog"===d.localName&&c.push(d),c=c.concat(d.querySelectorAll("dialog")))});c.length&&a(c)}))}};c.DialogManager.prototype.blockDocument=
function(){document.documentElement.addEventListener("focus",this.handleFocus_,!0);document.addEventListener("keydown",this.handleKey_);this.mo_&&this.mo_.observe(document,{childList:!0,subtree:!0})};c.DialogManager.prototype.unblockDocument=function(){document.documentElement.removeEventListener("focus",this.handleFocus_,!0);document.removeEventListener("keydown",this.handleKey_);this.mo_&&this.mo_.disconnect()};c.DialogManager.prototype.updateStacking=function(){for(var a=this.zIndexHigh_,b=0,c;c=
this.pendingDialogStack[b];++b)c.updateZIndex(--a,--a),0===b&&(this.overlay.style.zIndex=--a);(a=this.pendingDialogStack[0])?(a.dialog.parentNode||document.body).appendChild(this.overlay):this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay)};c.DialogManager.prototype.containedByTopDialog_=function(a){for(;a=e(a);){for(var b=0,c;c=this.pendingDialogStack[b];++b)if(c.dialog===a)return 0===b;a=a.parentElement}return!1};c.DialogManager.prototype.handleFocus_=function(a){if(!this.containedByTopDialog_(a.target)&&
document.activeElement!==document.documentElement&&(a.preventDefault(),a.stopPropagation(),n(a.target),void 0!==this.forwardTab_)){var b=this.pendingDialogStack[0];b.dialog.compareDocumentPosition(a.target)&Node.DOCUMENT_POSITION_PRECEDING&&(this.forwardTab_?b.focus_():a.target!==document.documentElement&&document.documentElement.focus());return!1}};c.DialogManager.prototype.handleKey_=function(a){this.forwardTab_=void 0;if(27===a.keyCode){a.preventDefault();a.stopPropagation();a=new k("cancel",{bubbles:!1,
cancelable:!0});var b=this.pendingDialogStack[0];b&&b.dialog.dispatchEvent(a)&&b.dialog.close()}else 9===a.keyCode&&(this.forwardTab_=!a.shiftKey)};c.DialogManager.prototype.checkDOM_=function(a){this.pendingDialogStack.slice().forEach(function(b){-1!==a.indexOf(b.dialog)?b.downgradeModal():b.maybeHideModal()})};c.DialogManager.prototype.pushDialog=function(a){if(this.pendingDialogStack.length>=(this.zIndexHigh_-this.zIndexLow_)/2-1)return!1;1===this.pendingDialogStack.unshift(a)&&this.blockDocument();
this.updateStacking();return!0};c.DialogManager.prototype.removeDialog=function(a){a=this.pendingDialogStack.indexOf(a);-1!==a&&(this.pendingDialogStack.splice(a,1),0===this.pendingDialogStack.length&&this.unblockDocument(),this.updateStacking())};c.dm=new c.DialogManager;c.formSubmitter=null;c.useValue=null;if(void 0===window.HTMLDialogElement){var h=document.createElement("form");h.setAttribute("method","dialog");if("dialog"!==h.method&&(h=Object.getOwnPropertyDescriptor(HTMLFormElement.prototype,
"method"))){var r=h.get;h.get=function(){return m(this)?"dialog":r.call(this)};var t=h.set;h.set=function(a){return"string"===typeof a&&"dialog"===a.toLowerCase()?this.setAttribute("method",a):t.call(this,a)};Object.defineProperty(HTMLFormElement.prototype,"method",h)}document.addEventListener("click",function(a){c.formSubmitter=null;c.useValue=null;if(!a.defaultPrevented){var b=a.target;if(b&&m(b.form)){if(!("submit"===b.type&&-1<["button","input"].indexOf(b.localName))){if("input"!==b.localName||
"image"!==b.type)return;c.useValue=a.offsetX+","+a.offsetY}e(b)&&(c.formSubmitter=b)}}},!1);var u=HTMLFormElement.prototype.submit;HTMLFormElement.prototype.submit=function(){if(!m(this))return u.call(this);var a=e(this);a&&a.close()};document.addEventListener("submit",function(a){var b=a.target;if(m(b)&&(a.preventDefault(),a=e(b))){var d=c.formSubmitter;d&&d.form===b?a.close(c.useValue||d.value):a.close();c.formSubmitter=null}},!0)}return c});
